<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Handshake &mdash; Metin2Dev Wiki</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/design-tabs.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../../index.html">
            <img src="https://raw.githubusercontent.com/Metin2-Dev/Assets/main/128_round_black.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Wiki</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Topics/index.html">Topics</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../Topics/Cryptography/index.html">Cryptography</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../Topics/Cryptography/index.html#algorythm-types">Algorythm Types</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../Topics/Cryptography/type_0.html">Raw (Type 0)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../Topics/Cryptography/type_1.html">-LZO (Type 1)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../Topics/Cryptography/type_2.html">~XTEA(-LZO) (Type 2)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../Topics/Cryptography/type_3.html">Panama (Type 3)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../Topics/Cryptography/type_4.html">HybridCrypt (Type 4)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../Topics/Cryptography/type_5.html">HybridCrypt+ (Type 5)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../Topics/Cryptography/type_6.html">~XTEA(-Snappy) (Type 6)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../Topics/Formats/index.html">Formats</a><ul class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../Topics/Networking/index.html">Networking</a><ul class="simple">
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Incomplete Topics</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../Formats/index.html">Formats</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../Formats/texture_caching.html">DDS Texture Caching</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../Formats/texture_caching.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../Formats/texture_caching.html#rdch-format">RDCH Format</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../About/Contributing/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../About/Changelogs/index.html">Changelogs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../About/Maintenance/index.html">Maintenance</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../About/Maintenance/workflow.html">Workflow</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../About/Maintenance/workflow.html#o-development-flow">1º - Development flow</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../About/Maintenance/workflow.html#o-beta-flow">2º - Beta flow</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../About/Maintenance/workflow.html#o-stable-release-flow">3º - Stable release flow</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Wiki</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Handshake</li>


      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/Metin2-Dev/Wiki/blob/main/pages/Incomplete/Networking/Synchronization/Handshake.md" class="fa fa-github"> Edit on GitHub</a>
      </li>

<style>
	.edit-guidelines {
		font-size: 14px;
		float: right;
		clear: both;
	}

	@media screen and (max-width: 480px) {
		.edit-guidelines {
			display: none;
		}
	}
</style>
<a class="edit-guidelines" href="">
	Check out how to contribute!
</a>


  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="handshake">
<h1>Handshake<a class="headerlink" href="#handshake" title="Permalink to this headline">¶</a></h1>
<p>A Handshake is the standard synchrony integrity verification, it is used
to make sure that agents communicating with each other are valid and aware
of phase states, encryption and time synchronization</p>
<p>It is always used first before data incoming to the game or authentication
agent can be accepted, and it is also performed when a phase change occurs</p>
<div class="section" id="shaking">
<h2>Shaking<a class="headerlink" href="#shaking" title="Permalink to this headline">¶</a></h2>
<p>To perform a handshake, the server generates a <em>Hand</em> which we are
going to call the <code class="docutils literal notranslate"><span class="pre">right</span> <span class="pre">hand</span></code>, gets it current time and a time delta (used for
synchronizing the time with the other agent) and puts it in a
<a class="reference internal" href="../Data/Packets/Handshake.html"><span class="doc std std-doc">Handshake</span></a> packet</p>
<p>It stores the hand and after that it sends it to the other agent and in the
<strong>next instruction</strong>, stores the current time and flags that a handshake
is happening, so that it can be used later for validation and synchronization</p>
<p>When the packet is received by the client agent, it generates a <em>Hand</em>
which we will call the <code class="docutils literal notranslate"><span class="pre">left</span> <span class="pre">hand</span></code>, stores the received server time contained
in the packet, creates a new equally formatted Handshake packet, puts the left
hand in it and sends it to the server agent</p>
<p>When the server agent receives it, checks if the hand is still the same as the
one that was last sent, if it isn’t the connection is terminated</p>
<p>Next it checks if it is in the Handshake Phase, if so it will validate if the
time between shakes is valid and synchronized, the process is explained below</p>
<p>If it is valid and synchronized, other synchronizations are perform, like the
<a class="reference internal" href="IPE.html"><span class="doc std std-doc">IPE</span></a></p>
</div>
<div class="section" id="synchronization-validation">
<h2>Synchronization validation<a class="headerlink" href="#synchronization-validation" title="Permalink to this headline">¶</a></h2>
<p>First it will start by checking if the received time delta from the packet
is below 0, if so it will return as invalid</p>
<p>Then it will check the time difference, adding the received Handshake packet’s
time and delta and subtracting to the current server time, for example:
<code class="docutils literal notranslate"><span class="pre">current_server_time</span> <span class="pre">-</span> <span class="pre">handshake_packet_time</span> <span class="pre">+</span> <span class="pre">handshake_packet_delta</span></code></p>
<p>Then it will check if the result is inbetween a range, by default is from <code class="docutils literal notranslate"><span class="pre">0</span></code>
to <code class="docutils literal notranslate"><span class="pre">50</span></code>, and if it is it means the handshake is valid, so it will store
the current time as the client agent’s time and set the handshake as done</p>
<p>Otherwise, if it is not in the range, the server agent will generate a new
delta by getting the current server time and subtracting it to the Handshake
packet time, then divided by two, for example:
<code class="docutils literal notranslate"><span class="pre">(current_server_time</span> <span class="pre">-</span> <span class="pre">handshake_packet_time)</span> <span class="pre">/</span> <span class="pre">2</span></code></p>
<p>Then it will increase the retry count by one and send it to the client
and the same process as since the whole beginning will occur, it will store
the time of when the packet was sent, the client will send it back to the
server, then validate and so on…</p>
<p>There is a limit for how many times this process can be retried,
by default its <code class="docutils literal notranslate"><span class="pre">32</span></code> times, but depends on the server settings for this
option</p>
</div>
<div class="section" id="hand-generation">
<h2>Hand generation<a class="headerlink" href="#hand-generation" title="Permalink to this headline">¶</a></h2>
<p>The hand is a pseudo random number from <code class="docutils literal notranslate"><span class="pre">0</span></code> to <code class="docutils literal notranslate"><span class="pre">4.294.967.295</span></code>
(the range of a 32-bit unsigned integer)</p>
</div>
</div>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019-2022.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>